<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motivations for cpp11 • cpp11</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Motivations for cpp11">
<meta property="og:description" content="cpp11">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cpp11</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/cpp11.html">Get started</a>
</li>
<li>
  <a href="../articles/motivations.html">Motivations</a>
</li>
<li>
  <a href="../articles/converting.html">Converting</a>
</li>
<li>
  <a href="../articles/internals.html">Internals</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/cpp11/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="motivations_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Motivations for cpp11</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/cpp11/blob/master/vignettes/motivations.Rmd"><code>vignettes/motivations.Rmd</code></a></small>
      <div class="hidden name"><code>motivations.Rmd</code></div>

    </div>

    
    
<div id="motivations" class="section level1">
<h1 class="hasAnchor">
<a href="#motivations" class="anchor"></a>Motivations</h1>
<p>R and S have a long history of interacting with compiled languages. In fact the original version of S written in the late 1970s was mainly a wrapper around FORTRAN routines. <a href="https://www.r-project.org/conferences/useR-2006/Slides/Chambers.pdf">(History-of-S)</a> Released in 2000, the <a href="https://cran.r-project.org/package=cxx">cxx</a> package was an early prototype of C++ bindings to R. <a href="https://cran.r-project.org/package=Rcpp">Rcpp</a> was first published to CRAN in 2008, and <a href="https://cran.r-project.org/package=Rcpp11">Rcpp11</a> in 2014. Of these <code>Rcpp</code> has by far the widest adoption, with over 2000 reverse dependencies as of 2020.</p>
<p>Rcpp has been a widely successful project, however over the years a number of issues and additional C++ features have arisen. Adding these features to Rcpp would require a great deal of work, or in some cases would be impossible without severely breaking backwards compatibility.</p>
<p>cpp11 is a ground up rewrite of C++ bindings to R with different design trade-offs and features.</p>
<p>Changes that motivated cpp11 include:</p>
<ul>
<li>Enforcing <a href="#copy-on-write-semantics">copy-on-write semantics</a>.</li>
<li>Improving the <a href="#improve-safety">safety</a> of using the R API from C++ code.</li>
<li>Supporting <a href="#altrep-support">ALTREP objects</a>.</li>
<li>Using <a href="#utf-8-everywhere">UTF-8 strings</a> everywhere.</li>
<li>Applying newer <a href="#c11-features">C++11 features</a>.</li>
<li>Having a more straightforward, <a href="#simpler-implementation">simpler implementation</a>.</li>
<li>Faster <a href="#compilation-speed">compilation time</a> with lower memory requirements.</li>
<li>Being <em>completely</em> <a href="#header-only">header only</a> to avoid ABI issues.</li>
<li>Capable of <a href="#vendoring">vendoring</a> if desired.</li>
<li>More robust <a href="#protection">protection</a> using a much more efficient linked list data structure.</li>
<li>
<a href="#growing-vectors">Growing vectors</a> more efficiently.</li>
</ul>
<div id="copy-on-write-semantics" class="section level2">
<h2 class="hasAnchor">
<a href="#copy-on-write-semantics" class="anchor"></a>Copy-on-write semantics</h2>
<p>R uses <a href="https://adv-r.hadley.nz/names-values.html#copy-on-modify">copy-on-write</a> (also called copy-on-modify) semantics. Lets say you have two variables <code>x</code> and <code>y</code> that both point to the same underlying data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span></code></pre></div>
<p>If you modify <code>y</code>, R will first copy the values of <code>x</code> to a new position, then point <code>y</code> to the new location and only after the copy modify <code>y</code>. This allows <code>x</code> to retain the original values.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="va">y</span>
<span class="co">#&gt; [1] 1 2 4</span>

<span class="va">x</span>
<span class="co">#&gt; [1] 1 2 3</span></code></pre></div>
<p>C++ does not have copy-on-write built into the language, however it has related concepts, copy-by-value and copy-by-reference. Copy-by-value works similarly to R, except that R only copies when something is changed, C++ <em>always</em> copies.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">int</span> x = <span class="dv">42</span>;</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="dt">int</span> y = x;</span>
<span id="cb3-3"><a href="#cb3-3"></a>y = <span class="dv">0</span>;</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">// x is still == 42</span></span></code></pre></div>
<p>Copy-by-reference does the opposite, both <code>x</code> and <code>y</code> always point to the <em>same</em> underlying value. In C++ you specify a reference with <code><a href="https://rdrr.io/r/base/Logic.html">&amp;</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="dt">int</span> x = <span class="dv">42</span>;</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="dt">int</span> &amp;y = x;</span>
<span id="cb4-3"><a href="#cb4-3"></a>y = <span class="dv">0</span>;</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">// both x and y are now 0</span></span></code></pre></div>
<p>Copy-by-reference is a valuable technique, as it avoids the overhead of copying the data. However it can also lead to errors when internal functions change their inputs unexpectedly. Rcpp uses copy-by-reference by default (even if you pass a Rcpp vector class by value). This gives Rcpp functions completely different semantics from normal R functions.</p>
<p>We can illustrate this by creating a Rcpp function that multiples its input vector by 2.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="pp">#include </span><span class="im">"Rcpp.h"</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp;</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>NumericVector times_two_rcpp(NumericVector x) {</span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; x.size(); ++i) {</span>
<span id="cb5-7"><a href="#cb5-7"></a>    x[i] = x[i] * <span class="dv">2</span>;</span>
<span id="cb5-8"><a href="#cb5-8"></a>  }</span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="cf">return</span> x;</span>
<span id="cb5-10"><a href="#cb5-10"></a>}</span></code></pre></div>
<p>If you do this with regular R functions, you will see the value of <code>y</code> is <code>x</code> * 2, but the value of <code>x</code> is unchanged.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">*</span> <span class="fl">2</span>
<span class="va">y</span>
<span class="co">#&gt; [1] 2 4 6</span>

<span class="va">x</span>
<span class="co">#&gt; [1] 1 2 3</span></code></pre></div>
<p>However if we now call our <code>times_two_rcpp()</code> function we get the right output value, but now <code>x</code> is <em>also changed</em>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">times_two_rcpp</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">z</span>
<span class="co">#&gt; [1] 2 4 6</span>

<span class="va">x</span>
<span class="co">#&gt; [1] 2 4 6</span></code></pre></div>
<p>cpp11 strives to make its functions behave similarly to normal R functions, while preserving the speed of Rcpp when read only access is needed. Each of the r_vector classes in cpp11 has a normal <em>read only</em> version that uses copy-by-reference, and a <em>writable</em> version which uses copy-by-value.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1"></a><span class="pp">#include </span><span class="im">"cpp11/doubles.hpp"</span></span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a>[[<span class="at">cpp11</span>::<span class="at">register</span>]]</span>
<span id="cb8-4"><a href="#cb8-4"></a>cpp11::doubles times_two_cpp11(cpp11::writable::doubles x) {</span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; x.size(); ++i) {</span>
<span id="cb8-6"><a href="#cb8-6"></a>    x[i] = x[i] * <span class="dv">2</span>;</span>
<span id="cb8-7"><a href="#cb8-7"></a>  }</span>
<span id="cb8-8"><a href="#cb8-8"></a>  <span class="cf">return</span> x;</span>
<span id="cb8-9"><a href="#cb8-9"></a>}</span></code></pre></div>
<p>Using <code>cpp11::writable::doubles</code> first <em>copies</em> the input vector, so when we do the multiplication we do not modify the original data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>

<span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">times_two_cpp11</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">z</span>
<span class="co">#&gt; [1] 2 4 6</span>

<span class="va">x</span>
<span class="co">#&gt; [1] 1 2 3</span></code></pre></div>
</div>
<div id="improve-safety" class="section level2">
<h2 class="hasAnchor">
<a href="#improve-safety" class="anchor"></a>Improve safety</h2>
<p>Internally R is written in C, not C++. In general C and C++ work well together, a large part of C++’s success is due to its high interoperability with C code. However one area in which C and C++ are generally <em>not</em> interoperable is error handling. In C++ the most common way to handle errors is with <a href="https://isocpp.org/wiki/faq/exceptions">exceptions</a>.</p>
<p>Exceptions provide a clean, safe way for objects to obtain and cleanup resources automatically even when errors occur.</p>
<div id="c-safety" class="section level3">
<h3 class="hasAnchor">
<a href="#c-safety" class="anchor"></a>C safety</h3>
<p>The C language does not have support for exceptions, so error handling is done a variety of ways. These include error codes like <a href="https://en.cppreference.com/w/c/error/errno">errno</a>, conditional statements, and in the R codebase the <a href="http://www.cplusplus.com/reference/csetjmp/longjmp/">longjmp</a> function.</p>
<p><code>longjmp</code>, which stands for ‘long jump’ is a function that allows you to transfer the control flow of a program to another location elsewhere in the program. R uses long jumps extensively in its error handling routines. If an R function is executing and an error occurs, a long jump is called which ‘jumps’ the control flow into the error handling code.</p>
<p>Crucially long jumps are <em>incompatible</em> with C++ <a href="https://isocpp.org/wiki/faq/dtors">destructors</a>. If a long jump occurs the destructors of any active C++ objects are not run, and therefore any resources (such as memory, file handles, etc.) managed by those objects will cause a <a href="https://en.wikipedia.org/wiki/Resource_leak">resource leak</a>.</p>
<p>For example, the following unsafe code would leak the memory allocated in the C++ <code>std::vector</code> <code>x</code> when the R API function <code>Rf_allocVector()</code> fails (since you can’t create a vector of <code>-1</code> size).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1"></a><span class="bu">std::</span>vector&lt;<span class="dt">double</span>&gt; x({<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>});</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>SEXP y = PROTECT(Rf_allocVector(REALSXP, -<span class="dv">1</span>));</span></code></pre></div>
<p>cpp11 provides two mechanisms to make interfacing with Rs C API and C++ code safer. <code>cpp11::unwind_protect()</code> takes a functional object (a C++11 lamdba function or <code>std::function</code>) and converts any C long jumps encountered to C++ exceptions. Now instead of a C long jump happening when the <code>Rf_allocVector()</code> call fails, a C++ exception occurs, which <em>does</em> trigger the <code>std::vector</code> destructor, so that memory is automatically released.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1"></a><span class="bu">std::</span>vector&lt;<span class="dt">double</span>&gt; x({<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>});</span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a>SEXP y;</span>
<span id="cb11-4"><a href="#cb11-4"></a>unwind_protect([]() {</span>
<span id="cb11-5"><a href="#cb11-5"></a>  y = Rf_allocVector(REALSXP, -<span class="dv">1</span>);</span>
<span id="cb11-6"><a href="#cb11-6"></a>})</span></code></pre></div>
<p><code>cpp11::safe()</code> is a more concise way to wrap a particular R API function with <code>unwind_protect()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1"></a><span class="bu">std::</span>vector&lt;<span class="dt">double</span>&gt; x({<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>});</span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>SEXP y = PROTECT(safe[Rf_allocVector](REALSXP, -<span class="dv">1</span>));</span></code></pre></div>
<p>Again using <code>cpp11::safe()</code> converts the C long jump to a C++ exception, so the memory is automatically released.</p>
<p>cpp11 uses these mechanisms extensively internally when calling the R C API, which make cpp11 much safer against resource leaks than using Rcpp or calling Rs C API by hand.</p>
</div>
<div id="c-safety-1" class="section level3">
<h3 class="hasAnchor">
<a href="#c-safety-1" class="anchor"></a>C++ safety</h3>
<p>In the inverse of C safety we also need to ensure that C++ exceptions do not reach the C call stack, as they will terminate R if that occurs. Like Rcpp, cpp11 automatically generates <code>try / catch</code> guards around registered functions to prevent this and also converts C++ exceptions into normal R errors. This is done without developer facing code changes.</p>
<p>With both C and C++ sides of the coin covered we can safely use R’s C API and C++ code together with C++ objects without leaking resources.</p>
</div>
</div>
<div id="altrep-support" class="section level2">
<h2 class="hasAnchor">
<a href="#altrep-support" class="anchor"></a>Altrep support</h2>
<p><a href="https://svn.r-project.org/R/branches/ALTREP/ALTREP.html">ALTREP</a> which stands for <strong>ALT</strong>ernative <strong>REP</strong>resntations is a feature introduced in R 3.5. ALTREP allows R internals and package authors to define alternative ways of representing data to R. One example of the use of altrep is the <code><a href="https://rdrr.io/r/base/Colon.html">:</a></code> operator.</p>
<p>Prior to R 3.5 <code><a href="https://rdrr.io/r/base/Colon.html">:</a></code> generated a full vector for the entire sequence. e.g. <code>1:1000</code> would require 1000 individual values. As of R 3.5 this sequence is instead represented by an ALTREP vector, so <em>none</em> of the values actually exist in memory. Instead each time R access a particular value in the sequence that value is computed on-the-fly. This saves memory and excution time, and allows users to use sequences which would otherwise be too big to fit in memory.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fl">1</span><span class="op">:</span><span class="fl">1e9</span>
<span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20</span>
<span class="co">#&gt;  [ reached getOption("max.print") -- omitted 999999980 entries ]</span></code></pre></div>
<p>Because Rcpp predates the introduction of ALTREP, it does not support the interfaces needed to access ALTREP objects. This means the objects must be converted to normal R objects as soon as they are used by Rcpp.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1"></a><span class="pp">#include </span><span class="im">"Rcpp.h"</span></span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>Rcpp::IntegerVector identity_rcpp(Rcpp::IntegerVector x) {</span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="cf">return</span> x;</span>
<span id="cb14-6"><a href="#cb14-6"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">identity_rcpp</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100000</span><span class="op">)</span>
<span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lobstr/man/obj_size.html">obj_size</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; 400,728 B</span></code></pre></div>
<p>Whereas cpp11 objects preserve the ALTREP object.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1"></a><span class="pp">#include </span><span class="im">"cpp11/integers.hpp"</span></span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a>[[<span class="at">cpp11</span>::<span class="at">register</span>]]</span>
<span id="cb16-4"><a href="#cb16-4"></a>cpp11::integers identity_cpp11(cpp11::integers x) {</span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="cf">return</span> x;</span>
<span id="cb16-6"><a href="#cb16-6"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">identity_cpp11</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100000</span><span class="op">)</span>
<span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lobstr/man/obj_size.html">obj_size</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; 680 B</span></code></pre></div>
<div id="altrep-benchmarks" class="section level3">
<h3 class="hasAnchor">
<a href="#altrep-benchmarks" class="anchor"></a>Altrep benchmarks</h3>
<p>In these benchmarks note that Rcpp allocates memory for the ALTREP vectors. This is because Rcpp implicitly converts them into normal R vectors. cpp11 retains them as ALTREP vectors, so no additional memory is needed.</p>
<p><code>foreach</code> and <code>accumulate</code> both use iterators that take advantage of <code>REAL_GET_REGION</code> to buffer queries. This makes them faster than naive C-style for loops with ALTREP vectors.</p>
<p>The for2 case shows an optimization you can use if you know at compile-time that you won’t be dealing with ALTREP vectors. By specifying <code>false</code> to the second argument (<code>is_altrep</code>), you can disable the ALTREP support. This causes the ALTREP conditional code to be compiled out resulting in loop unrolling (and speeds) identical to that generated by Rcpp.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cpp11test</span><span class="op">)</span>

<span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>
  len <span class="op">=</span> <span class="fl">3e6</span>,
  vector <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"normal"</span>, <span class="st">"altrep"</span><span class="op">)</span>,
  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"for"</span>, <span class="st">"foreach"</span>, <span class="st">"accumulate"</span><span class="op">)</span>,
  pkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cpp11"</span>, <span class="st">"rcpp"</span><span class="op">)</span>,
  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># Add special case</span>
<span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>len <span class="op">=</span> <span class="fl">3e6</span>, vector <span class="op">=</span> <span class="st">"normal"</span>, method <span class="op">=</span> <span class="st">"for2"</span>, pkg <span class="op">=</span> <span class="st">"cpp11"</span><span class="op">)</span>, <span class="va">cases</span><span class="op">)</span>

<span class="va">b_sum</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/press.html">press</a></span><span class="op">(</span>
  .grid <span class="op">=</span> <span class="va">cases</span>,
  <span class="op">{</span>
    <span class="va">seq_real</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
    <span class="va">funs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"normal"</span> <span class="op">=</span> <span class="va">rnorm</span>, <span class="st">"altrep"</span> <span class="op">=</span> <span class="va">seq_real</span><span class="op">)</span>
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">funs</span><span class="op">[[</span><span class="va">vector</span><span class="op">]</span><span class="op">]</span><span class="op">(</span><span class="va">len</span><span class="op">)</span>
    <span class="va">fun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.fun.html">match.fun</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%ssum_dbl_%s_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">pkg</span> <span class="op">==</span> <span class="st">"cpp11"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"_"</span><span class="op">)</span><span class="op">)</span>, <span class="va">method</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
      <span class="fu">fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pkg"</span>, <span class="st">"method"</span>, <span class="st">"vector"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"mem_alloc"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">b_sum</span>, <span class="st">"sum.Rds"</span>, version <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"sum.Rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">pkg</th>
<th align="left">method</th>
<th align="left">vector</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">mem_alloc</th>
<th align="right">itr/sec</th>
<th align="right">n_gc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">cpp11</td>
<td align="left">for2</td>
<td align="left">normal</td>
<td align="right">0.003008334</td>
<td align="right">0.003208736</td>
<td align="right">0</td>
<td align="right">302.9364</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">cpp11</td>
<td align="left">for</td>
<td align="left">normal</td>
<td align="right">0.002929285</td>
<td align="right">0.003088721</td>
<td align="right">0</td>
<td align="right">319.9100</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">cpp11</td>
<td align="left">for</td>
<td align="left">altrep</td>
<td align="right">0.008089832</td>
<td align="right">0.008442934</td>
<td align="right">0</td>
<td align="right">117.0562</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">cpp11</td>
<td align="left">foreach</td>
<td align="left">normal</td>
<td align="right">0.002966348</td>
<td align="right">0.003361415</td>
<td align="right">0</td>
<td align="right">292.8306</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">cpp11</td>
<td align="left">foreach</td>
<td align="left">altrep</td>
<td align="right">0.004017410</td>
<td align="right">0.004184819</td>
<td align="right">0</td>
<td align="right">236.2339</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">cpp11</td>
<td align="left">accumulate</td>
<td align="left">normal</td>
<td align="right">0.003033590</td>
<td align="right">0.003241419</td>
<td align="right">0</td>
<td align="right">303.3408</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">cpp11</td>
<td align="left">accumulate</td>
<td align="left">altrep</td>
<td align="right">0.004067195</td>
<td align="right">0.004311647</td>
<td align="right">0</td>
<td align="right">225.8066</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">rcpp</td>
<td align="left">for</td>
<td align="left">normal</td>
<td align="right">0.002807784</td>
<td align="right">0.003127156</td>
<td align="right">0</td>
<td align="right">311.3724</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">rcpp</td>
<td align="left">for</td>
<td align="left">altrep</td>
<td align="right">0.002805196</td>
<td align="right">0.003131571</td>
<td align="right">24000048</td>
<td align="right">311.6365</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">rcpp</td>
<td align="left">foreach</td>
<td align="left">normal</td>
<td align="right">0.002928401</td>
<td align="right">0.003462064</td>
<td align="right">0</td>
<td align="right">293.9831</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">rcpp</td>
<td align="left">foreach</td>
<td align="left">altrep</td>
<td align="right">0.002810107</td>
<td align="right">0.003068041</td>
<td align="right">24000048</td>
<td align="right">313.6250</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">rcpp</td>
<td align="left">accumulate</td>
<td align="left">normal</td>
<td align="right">0.002803584</td>
<td align="right">0.003006378</td>
<td align="right">0</td>
<td align="right">321.6647</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">rcpp</td>
<td align="left">accumulate</td>
<td align="left">altrep</td>
<td align="right">0.002750792</td>
<td align="right">0.003000370</td>
<td align="right">24000048</td>
<td align="right">322.9292</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><a href="https://github.com/r-lib/cpp11/blob/master/cpp11test/src/sum.cpp">cpp11test/src/sum.cpp</a> contains the code ran in these benchmarks.</p>
</div>
</div>
<div id="utf-8-everywhere" class="section level2">
<h2 class="hasAnchor">
<a href="#utf-8-everywhere" class="anchor"></a>UTF-8 everywhere</h2>
<p>R has complicated support for Unicode strings and non-ASCII code pages, whose behavior often differs substantially on different operating systems, particularly Windows. Correctly dealing with this is challenging and often feels like whack a mole.</p>
<p>To combat this complexity cpp11 uses the <a href="http://utf8everywhere.org/">UTF-8 everywhere</a> philosophy. This means that whenever text data is converted from R data structures to C++ data structures by cpp11 the data is translated into UTF-8. Conversely any text data coming from C++ code is assumed to be UTF-8 and marked as such for R. Doing this universally avoids many locale specific issues when dealing with Unicode text.</p>
<p>Concretely cpp11 always uses <code>Rf_translateCharUTF8()</code> when obtaining <code>const char*</code> from <code>CHRSXP</code> objects and uses <code>Rf_mkCharCE(, CE_UTF8)</code> when creating new <code>CHRSXP</code> objects from <code>const char*</code> inputs.</p>
<!--TODO: unicode examples?-->
</div>
<div id="c11-features" class="section level2">
<h2 class="hasAnchor">
<a href="#c11-features" class="anchor"></a>C++11 features</h2>
<p>C++11 provides a host of new features to the C++ language. cpp11 uses a number of these including</p>
<ul>
<li><a href="https://en.cppreference.com/w/cpp/language/move_constructor">move semantics</a></li>
<li><a href="https://en.cppreference.com/w/cpp/header/type_traits">type traits</a></li>
<li><a href="https://en.cppreference.com/w/cpp/utility/initializer_list">initializer_list</a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/parameter_pack">variadic templates / parameter packs</a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/user_literal">user defined literals</a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/attributes">user defined attributes</a></li>
</ul>
</div>
<div id="simpler-implementation" class="section level2">
<h2 class="hasAnchor">
<a href="#simpler-implementation" class="anchor"></a>Simpler implementation</h2>
<p>Rcpp is very ambitious, with a number of advanced features, including <a href="https://cran.r-project.org/package=Rcpp/vignettes/Rcpp-modules.pdf">modules</a>, <a href="https://cran.r-project.org/package=Rcpp/vignettes/Rcpp-sugar.pdf">sugar</a> and extensive support for <a href="https://CRAN.R-project.org/package=Rcpp/vignettes/Rcpp-attributes.pdf">attributes</a>. While these are useful features, many R packages do not use one or any of these advanced features. In addition the code needed to support these features is complex and can be challenging to maintain.</p>
<p>cpp11 takes a more limited scope, providing only the set of r_vector wrappers for R vector types, coercion methods to and from C++ and the limited attributes necessary to support use in R packages.</p>
<p>This limited scope allows the implementation to be much simpler, the headers in Rcpp 1.0.4 have 74,658 lines of code (excluding blank or commented lines) in 379 files. Some headers in Rcpp are automatically generated, removing these still gives you 25,249 lines of code in 357 files. In contrast the headers in cpp11 contain only 1,734 lines of code in 19 files.</p>
<p>This reduction in complexity should make cpp11 an easier project to maintain and ensure correctness, particularly around interactions with the R garbage collector.</p>
<!--TODO: mention rchk compatibility here?-->
</div>
<div id="compilation-speed" class="section level2">
<h2 class="hasAnchor">
<a href="#compilation-speed" class="anchor"></a>Compilation speed</h2>
<p>Rcpp always bundles all of its headers together, which causes slow compilation times and high peak memory usage when compiling. The headers in cpp11 are more easily decoupled, so you only can include only the particular headers you actually use in a source file. This can significantly improve the compilation speed and memory usage to compile your package.</p>
<p>Here are some real examples of the reduction in compile time and peak memory usage after converting packages to cpp11.</p>
<table class="table">
<colgroup>
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th>package</th>
<th>Rcpp compile time</th>
<th>cpp11 compile time</th>
<th>Rcpp peak memory</th>
<th>cpp11 peak memory</th>
<th>Rcpp commit</th>
<th>cpp11 commit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>haven</td>
<td>17.42s</td>
<td>7.13s</td>
<td>428MB</td>
<td>204MB</td>
<td><a href="https://github.com/tidyverse/haven/compare/a3cf75a4...978cb034">a3cf75a4</a></td>
<td><a href="https://github.com/tidyverse/haven/compare/a3cf75a4...978cb034">978cb034</a></td>
</tr>
<tr class="even">
<td>readr</td>
<td>124.13s</td>
<td>81.08s</td>
<td>969MB</td>
<td>684MB</td>
<td><a href="https://github.com/tidyverse/readr/compare/ec0d8989...aa89ff72">ec0d8989</a></td>
<td><a href="https://github.com/tidyverse/readr/compare/ec0d8989...aa89ff72">aa89ff72</a></td>
</tr>
<tr class="odd">
<td>roxygen2</td>
<td>17.34s</td>
<td>4.24s</td>
<td>371MB</td>
<td>109MB</td>
<td><a href="https://github.com/r-lib/roxygen2/compare/6f081b75...e8e1e22d">6f081b75</a></td>
<td><a href="https://github.com/r-lib/roxygen2/compare/6f081b75...e8e1e22d">e8e1e22d</a></td>
</tr>
<tr class="even">
<td>tidyr</td>
<td>14.25s</td>
<td>3.34s</td>
<td>363MB</td>
<td>83MB</td>
<td><a href="https://github.com/tidyverse/tidyr/compare/3899ed51...60f7c7d4">3899ed51</a></td>
<td><a href="https://github.com/tidyverse/tidyr/compare/3899ed51...60f7c7d4">60f7c7d4</a></td>
</tr>
</tbody>
</table>
</div>
<div id="header-only" class="section level2">
<h2 class="hasAnchor">
<a href="#header-only" class="anchor"></a>Header only</h2>
<p>Rcpp has long been a <em>mostly</em> <a href="https://en.wikipedia.org/wiki/Header-only">header only</a> library, however is not a <em>completely</em> header only library. There have been <a href="https://github.com/tidyverse/dplyr/issues/2308">cases</a> when a package was first installed with version X of Rcpp, and then a newer version of Rcpp was later installed. Then when the original package X was loaded R would crash, because the <a href="https://en.wikipedia.org/wiki/Application_binary_interface">Application Binary Interface</a> of Rcpp had changed between the two versions.</p>
<p>Because cpp11 consists of exclusively headers this issue does not occur.</p>
</div>
<div id="vendoring" class="section level2">
<h2 class="hasAnchor">
<a href="#vendoring" class="anchor"></a>Vendoring</h2>
<p>In the go community the concept of <a href="https://go.googlesource.com/proposal/+/master/design/25719-go15vendor.md">vendoring</a> is widespread. Vendoring means that you copy the code for the dependencies into your project’s source tree. This ensures the dependency code is fixed and stable until it is updated. Because cpp11 is fully <a href="#header-only">header only</a> you can vendor the code in the same way. <code>cpp11::vendor_cpp11()</code> is provided to do this if you choose.</p>
<p>Vendoring has advantages and drawbacks however. The advantage is that changes to the cpp11 project could never break your existing code. The drawbacks are both minor, your package size is now slightly larger, and major, you no longer get bugfixes and new features until you explicitly update cpp11.</p>
<p>I think the majority of packages should use <code>LinkingTo: cpp11</code> and <em>not</em> vendor the cpp11 dependency. However, vendoring can be appropriate for certain situations.</p>
</div>
<div id="protection" class="section level2">
<h2 class="hasAnchor">
<a href="#protection" class="anchor"></a>Protection</h2>
<p>cpp11 uses a custom double linked list data structure to track objects it is managing. This struture is much more efficient for large numbers of objects than using <code>R_PreserveObject()</code> / <code>R_ReleaseObjects()</code> as is done in Rcpp.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cpp11test</span><span class="op">)</span>
<span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span> <span class="op">^</span> <span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">2e5</span><span class="op">)</span>, pkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cpp11"</span>, <span class="st">"rcpp"</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">b_release</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/press.html">press</a></span><span class="op">(</span>.grid <span class="op">=</span> <span class="va">grid</span>,
  <span class="op">{</span>
    <span class="va">fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.fun.html">match.fun</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%s_release_"</span>, <span class="va">pkg</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
      <span class="fu">fun</span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
      iterations <span class="op">=</span> <span class="fl">1</span>
    <span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"len"</span>, <span class="st">"pkg"</span>, <span class="st">"min"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">b_release</span>, <span class="st">"release.Rds"</span>, version <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="motivations_files/figure-html/unnamed-chunk-19-1.svg" width="700"></p>
<p>This plot shows the average time to protect and release a given object is essentially constant for cpp11. Whereas it is linear or worse with the number of objects being tracked for Rcpp.</p>
<table class="table">
<thead><tr class="header">
<th align="right">len</th>
<th align="left">pkg</th>
<th align="right">min</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1e+02</td>
<td align="left">cpp11</td>
<td align="right">26.28µs</td>
</tr>
<tr class="even">
<td align="right">1e+03</td>
<td align="left">cpp11</td>
<td align="right">127.51µs</td>
</tr>
<tr class="odd">
<td align="right">1e+04</td>
<td align="left">cpp11</td>
<td align="right">1.36ms</td>
</tr>
<tr class="even">
<td align="right">1e+05</td>
<td align="left">cpp11</td>
<td align="right">14.89ms</td>
</tr>
<tr class="odd">
<td align="right">2e+05</td>
<td align="left">cpp11</td>
<td align="right">35.62ms</td>
</tr>
<tr class="even">
<td align="right">1e+02</td>
<td align="left">rcpp</td>
<td align="right">6.7ms</td>
</tr>
<tr class="odd">
<td align="right">1e+03</td>
<td align="left">rcpp</td>
<td align="right">1.62ms</td>
</tr>
<tr class="even">
<td align="right">1e+04</td>
<td align="left">rcpp</td>
<td align="right">340.38ms</td>
</tr>
<tr class="odd">
<td align="right">1e+05</td>
<td align="left">rcpp</td>
<td align="right">24.79s</td>
</tr>
<tr class="even">
<td align="right">2e+05</td>
<td align="left">rcpp</td>
<td align="right">1.81m</td>
</tr>
</tbody>
</table>
</div>
<div id="growing-vectors" class="section level2">
<h2 class="hasAnchor">
<a href="#growing-vectors" class="anchor"></a>Growing vectors</h2>
<p>One major difference in Rcpp and cpp11 is how vectors are grown. Rcpp vectors have a <code>push_back()</code> method, but unlike <code>std::vector()</code> no additional space is reserved when pushing. This makes calling <code>push_back()</code> repeatably very expensive, as the entire vector has to be copied each call.</p>
<p>In contrast <code>cpp11</code> vectors grow efficiently, reserving extra space. Because of this you can do ~10,000,000 vector appends with cpp11 in approximately the same amount of time that Rcpp does 10,000, as this benchmark demonstrates.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>len <span class="op">=</span> <span class="fl">10</span> <span class="op">^</span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>, pkg <span class="op">=</span> <span class="st">"cpp11"</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>
  <span class="va">grid</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>len <span class="op">=</span> <span class="fl">10</span> <span class="op">^</span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, pkg <span class="op">=</span> <span class="st">"rcpp"</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">b_grow</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/press.html">press</a></span><span class="op">(</span>.grid <span class="op">=</span> <span class="va">grid</span>,
  <span class="op">{</span>
    <span class="va">fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.fun.html">match.fun</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%sgrow_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">pkg</span> <span class="op">==</span> <span class="st">"cpp11"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"_"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
      <span class="fu">fun</span><span class="op">(</span><span class="va">len</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"len"</span>, <span class="st">"pkg"</span>, <span class="st">"min"</span>, <span class="st">"mem_alloc"</span>, <span class="st">"n_itr"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">b_grow</span>, <span class="st">"growth.Rds"</span>, version <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="motivations_files/figure-html/unnamed-chunk-22-1.svg" width="700"></p>
<table class="table">
<thead><tr class="header">
<th align="right">len</th>
<th align="left">pkg</th>
<th align="right">min</th>
<th align="right">mem_alloc</th>
<th align="right">n_itr</th>
<th align="right">n_gc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1e+00</td>
<td align="left">cpp11</td>
<td align="right">3.3µs</td>
<td align="right">0B</td>
<td align="right">10000</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1e+01</td>
<td align="left">cpp11</td>
<td align="right">6.05µs</td>
<td align="right">0B</td>
<td align="right">9999</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">1e+02</td>
<td align="left">cpp11</td>
<td align="right">8.49µs</td>
<td align="right">1.89KB</td>
<td align="right">10000</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1e+03</td>
<td align="left">cpp11</td>
<td align="right">14.18µs</td>
<td align="right">16.03KB</td>
<td align="right">9999</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">1e+04</td>
<td align="left">cpp11</td>
<td align="right">63.77µs</td>
<td align="right">256.22KB</td>
<td align="right">3477</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">1e+05</td>
<td align="left">cpp11</td>
<td align="right">443.32µs</td>
<td align="right">2MB</td>
<td align="right">404</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="right">1e+06</td>
<td align="left">cpp11</td>
<td align="right">3.99ms</td>
<td align="right">16MB</td>
<td align="right">70</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">1e+07</td>
<td align="left">cpp11</td>
<td align="right">105.51ms</td>
<td align="right">256MB</td>
<td align="right">1</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="right">1e+00</td>
<td align="left">rcpp</td>
<td align="right">2.64µs</td>
<td align="right">0B</td>
<td align="right">10000</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1e+01</td>
<td align="left">rcpp</td>
<td align="right">3.13µs</td>
<td align="right">0B</td>
<td align="right">9999</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">1e+02</td>
<td align="left">rcpp</td>
<td align="right">13.87µs</td>
<td align="right">42.33KB</td>
<td align="right">9997</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">1e+03</td>
<td align="left">rcpp</td>
<td align="right">440.77µs</td>
<td align="right">3.86MB</td>
<td align="right">319</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">1e+04</td>
<td align="left">rcpp</td>
<td align="right">54.13ms</td>
<td align="right">381.96MB</td>
<td align="right">2</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>Rcpp has been and will continue to be widely successful. cpp11 is a alternative implementation of C++ bindings to R that chooses different design trade-offs and features. Both packages can co-exist (even be used in the same package!) and continue to enrich the R community.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://jimhester.com">Jim Hester</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
