<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Converting from Rcpp • cpp11</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Converting from Rcpp">
<script defer data-domain="cpp11.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cpp11</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.5.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/cpp11.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/motivations.html">Motivations</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/converting.html">Converting</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/FAQ.html">FAQ</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/internals.html">Internals</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><a class="dropdown-item" href="../news/index.html">Change log</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/cpp11/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Converting from Rcpp</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/cpp11/blob/main/vignettes/converting.Rmd" class="external-link"><code>vignettes/converting.Rmd</code></a></small>
      <div class="d-none name"><code>converting.Rmd</code></div>
    </div>

    
    
<p>In many cases there is no need to convert a package from Rcpp. If the
code is already written and you don’t have a very compelling need to use
cpp11 I would recommend you continue to use Rcpp. However if you
<em>do</em> feel like your project will benefit from using cpp11 this
vignette will provide some guidance and doing the conversion.</p>
<div class="section level2">
<h2 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Add cpp11 by calling <code>usethis::use_cpp11()</code>.</p></li>
<li>
<p>Start converting function by function.</p>
<p>Converting the code a bit at a time (and regularly running your
tests) is the best way to do the conversion correctly and make progress.
Doing a separate commit after converting each file (or possibly each
function) can make finding any regressions with <a href="https://youtu.be/KKeucpfAuuA" class="external-link">git bisect</a> much easier in the
future.</p>
<ol style="list-style-type: decimal">
<li>Convert <code>#include &lt;Rcpp.h&gt;</code> to
<code>#include &lt;cpp11.hpp&gt;</code>.</li>
<li>Convert all instances of <code>// [[Rcpp::export]]</code> to
<code>[[cpp11::register]]</code>.</li>
<li>Grep for <code>Rcpp::</code> and replace with the equivalent cpp11
function using the cheatsheets below.</li>
</ol>
</li>
<li>
<p>Remove Rcpp</p>
<ol style="list-style-type: decimal">
<li>Remove Rcpp from the <code>LinkingTo</code> and <code>Imports</code>
fields.</li>
<li>Remove <code>@importFrom Rcpp sourceCpp</code>.</li>
<li>Delete <code>src/RccpExports.cpp</code> and
<code>R/RcppExports.R</code>.</li>
<li>Delete <code>src/Makevars</code> if it only contains
<code>PKG_CPPFLAGS=-DSTRICT_R_HEADERS</code>.</li>
<li>Clean out old compiled code with
<code><a href="https://pkgbuild.r-lib.org/reference/clean_dll.html" class="external-link">pkgbuild::clean_dll()</a></code>.</li>
<li>Re-document the package to update the <code>NAMESPACE</code>.</li>
</ol>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="cheatsheet">Cheatsheet<a class="anchor" aria-label="anchor" href="#cheatsheet"></a>
</h2>
<div class="section level3">
<h3 id="vectors">Vectors<a class="anchor" aria-label="anchor" href="#vectors"></a>
</h3>
<table class="table">
<colgroup>
<col width="24%">
<col width="30%">
<col width="44%">
</colgroup>
<thead><tr class="header">
<th>Rcpp</th>
<th>cpp11 (read-only)</th>
<th>cpp11 (writable)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>NumericVector</td>
<td>doubles</td>
<td>writable::doubles</td>
</tr>
<tr class="even">
<td>NumericMatrix</td>
<td>doubles_matrix&lt;&gt;</td>
<td>writable::doubles_matrix&lt;&gt;</td>
</tr>
<tr class="odd">
<td>IntegerVector</td>
<td>integers</td>
<td>writable::integers</td>
</tr>
<tr class="even">
<td>IntegerMatrix</td>
<td>integers_matrix&lt;&gt;</td>
<td>writable::integers_matrix&lt;&gt;</td>
</tr>
<tr class="odd">
<td>CharacterVector</td>
<td>strings</td>
<td>writable::strings</td>
</tr>
<tr class="even">
<td>RawVector</td>
<td>raws</td>
<td>writable::raws</td>
</tr>
<tr class="odd">
<td>List</td>
<td>list</td>
<td>writable::list</td>
</tr>
<tr class="even">
<td>RObject</td>
<td>sexp</td>
<td></td>
</tr>
</tbody>
</table>
<p>Note that each cpp11 vector class has a read-only and writeable
version. The default classes, e.g. <code>cpp11::doubles</code> are
<em>read-only</em> classes that do not permit modification. If you want
to modify the data you or create a new vector, use the writeable
variant.</p>
<p>Another major difference in Rcpp and cpp11 is how vectors are grown.
Rcpp vectors have a <code>push_back()</code> method, but unlike
<code>std::vector()</code> no additional space is reserved when pushing.
This makes calling <code>push_back()</code> repeatably very expensive,
as the entire vector has to be copied each call. In contrast
<code>cpp11</code> vectors grow efficiently, reserving extra space. See
<a href="https://cpp11.r-lib.org/articles/motivations.html#growing-vectors" class="uri">https://cpp11.r-lib.org/articles/motivations.html#growing-vectors</a>
for more details.</p>
<p>Rcpp also allows very flexible implicit conversions, e.g. if you pass
a <code>REALSXP</code> to a function that takes a
<code>Rcpp::IntegerVector()</code> it is implicitly converted to a
<code>INTSXP</code>. These conversions are nice for usability, but
require (implicit) duplication of the data, with the associated runtime
costs. cpp11 throws an error in these cases. If you want the implicit
coercions you can add a call to <code><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer()</a></code> or
<code><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double()</a></code> as appropriate from R when you call the
function.</p>
</div>
<div class="section level3">
<h3 id="other-objects">Other objects<a class="anchor" aria-label="anchor" href="#other-objects"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Rcpp</th>
<th>cpp11</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>XPtr</td>
<td>external_pointer</td>
</tr>
<tr class="even">
<td>Environment</td>
<td>environment</td>
</tr>
<tr class="odd">
<td>Function</td>
<td>function</td>
</tr>
<tr class="even">
<td>Environment (namespace)</td>
<td>package</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Rcpp</th>
<th>cpp11</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>wrap()</code></td>
<td><code>as_sexp()</code></td>
</tr>
<tr class="even">
<td><code>as()</code></td>
<td><code>as_cpp()</code></td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code></td>
<td><code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code></td>
</tr>
<tr class="even">
<td><code>checkUserInterrupt()</code></td>
<td><code>check_user_interrupt()</code></td>
</tr>
<tr class="odd">
<td><code>CharacterVector::create("a", "b", "c")</code></td>
<td><code>{"a", "b", "c"}</code></td>
</tr>
</tbody>
</table>
<p>Note that <code><a href="https://rdrr.io/r/base/stop.html" class="external-link">cpp11::stop()</a></code> and
<code><a href="https://rdrr.io/r/base/warning.html" class="external-link">cpp11::warning()</a></code> are thin wrappers around
<code>Rf_stop()</code> and <code>Rf_warning()</code>. These are simple C
functions with a <code>printf()</code> API, so they do not understand
C++ objects like <code>std::string</code>. Therefore you need to call
<code>obj.c_str()</code> when passing string data to them.</p>
</div>
<div class="section level3">
<h3 id="r-functions">R functions<a class="anchor" aria-label="anchor" href="#r-functions"></a>
</h3>
<p>Calling R functions from C++ is similar to using Rcpp.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">// Rcpp -----------------------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>Rcpp<span class="op">::</span>Function as_tibble<span class="op">(</span><span class="st">"as_tibble"</span><span class="op">,</span> Rcpp<span class="op">::</span>Environment<span class="op">::</span>namespace_env<span class="op">(</span><span class="st">"tibble"</span><span class="op">));</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>as_tibble<span class="op">(</span>x<span class="op">,</span> Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">".rows"</span><span class="op">,</span> num_rows<span class="op">),</span> Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">".name_repair"</span><span class="op">,</span> name_repair<span class="op">));</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co">// cpp11 -----------------------------------------------</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> cpp11<span class="op">::</span>literals<span class="op">;</span> <span class="co">// so we can use ""_nm syntax</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="kw">auto</span> as_tibble <span class="op">=</span> cpp11<span class="op">::</span>package<span class="op">(</span><span class="st">"tibble"</span><span class="op">)[</span><span class="st">"as_tibble"</span><span class="op">];</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>as_tibble<span class="op">(</span>x<span class="op">,</span> <span class="st">".rows"</span><span class="op">_nm</span> <span class="op">=</span> num_rows<span class="op">,</span> <span class="st">".name_repair"</span><span class="op">_nm</span> <span class="op">=</span> name_repair<span class="op">);</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="unsupported-rcpp-features">Unsupported Rcpp features<a class="anchor" aria-label="anchor" href="#unsupported-rcpp-features"></a>
</h3>
<ul>
<li>None of <a href="https://CRAN.R-project.org/package=Rcpp/vignettes/Rcpp-modules.pdf" class="external-link">Modules</a>
</li>
<li>None of <a href="https://CRAN.R-project.org/package=Rcpp/vignettes/Rcpp-sugar.pdf" class="external-link">Sugar</a>
</li>
<li>Some parts of <a href="https://CRAN.R-project.org/package=Rcpp/vignettes/Rcpp-attributes.pdf" class="external-link">Attributes</a>
<ul>
<li>No dependencies</li>
<li>No random number generator restoration</li>
<li>No support for roxygen2 comments</li>
<li>No interfaces</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="rngs">RNGs<a class="anchor" aria-label="anchor" href="#rngs"></a>
</h3>
<p>Rcpp includes calls to <code>GetRNGstate()</code> and
<code>PutRNGstate()</code> around the wrapped function. This ensures
that if any C++ code calls the R API functions <code>unif_rand()</code>,
<code>norm_rand()</code>, <code>exp_rand()</code>, or
<code>R_unif_index()</code> the random seed state is set accordingly.
cpp11 does <em>not</em> do this, so you must include the calls to
<code>GetRNGstate()</code> and <code>PutRNGstate()</code>
<em>yourself</em> if you use any of those functions in your C++ code.
See <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Random-numbers" class="external-link">R-exts
6.3 - Random number generation</a> for details on these functions.</p>
<p>One convenient way to do safely is to use a simple class:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">class</span> local_rng <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  local_rng<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    GetRNGstate<span class="op">();</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>  <span class="op">~</span>local_rng<span class="op">(){</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    PutRNGstate<span class="op">();</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="dt">void</span> foo<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>  local_rng rng_state<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>  <span class="co">/* my code using the RNG */</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="common-issues-when-converting">Common issues when converting<a class="anchor" aria-label="anchor" href="#common-issues-when-converting"></a>
</h2>
<div class="section level3">
<h3 id="stl-includes">STL includes<a class="anchor" aria-label="anchor" href="#stl-includes"></a>
</h3>
<p>Rcpp.h includes a number of STL headers automatically, notably
<code>&lt;string&gt;</code> and <code>&lt;vector&gt;</code>, however the
cpp11 headers generally do not. If you have errors like</p>
<pre><code>error: no type named 'string' in namespace 'std'</code></pre>
<p>You will need to include the appropriate STL header, in this case
<code>&lt;string&gt;</code>.</p>
</div>
<div class="section level3">
<h3 id="strict-headers">Strict headers<a class="anchor" aria-label="anchor" href="#strict-headers"></a>
</h3>
<p>If you see something like this:</p>
<pre><code> In file included from file.cpp:1:
 In file included from path/cpp11/include/cpp11.hpp:3:
 path/cpp11/include/cpp11/R.hpp:12:9: warning: 'STRICT_R_HEADERS' macro redefined [-Wmacro-redefined]
 #define STRICT_R_HEADERS</code></pre>
<p>Make sure to remove <code>PKG_CPPFLAGS=-DSTRICT_R_HEADERS</code> from
<code>src/Makevars</code>.</p>
</div>
<div class="section level3">
<h3 id="r-api-includes">R API includes<a class="anchor" aria-label="anchor" href="#r-api-includes"></a>
</h3>
<p>cpp11 conflicts with macros declared by some R headers unless the
macros <code>R_NO_REMAP</code> and <code>STRICT_R_HEADERS</code> are
defined. If you include <code>cpp11.hpp</code> (or, at a minimum,
<code>cpp11/R.hpp</code>) before any R headers these macros will be
defined appropriately, otherwise you may see errors like</p>
<blockquote>
<p>R headers were included before cpp11 headers and at least one of
R_NO_REMAP or STRICT_R_HEADERS was not defined.</p>
</blockquote>
<p>Which indicate that you must either change your include order or add
preprocessor definitions for <code>R_NO_REMAP</code> and
<code>STRICT_R_HEADERS</code>. Note that transitive includes of R
headers (for example, those included by <code>Rcpp.h</code>) can also
introduce the conflicting macros.</p>
</div>
<div class="section level3">
<h3 id="type-aliases">Type aliases<a class="anchor" aria-label="anchor" href="#type-aliases"></a>
</h3>
<p>If you use typedefs for cpp11 types or define custom types you will
need to define them in a <code>pkgname_types.hpp</code> file so that
<code><a href="../reference/cpp_register.html">cpp_register()</a></code> can include it in the generated code.</p>
</div>
<div class="section level3">
<h3 id="logical-vector-construction">Logical vector construction<a class="anchor" aria-label="anchor" href="#logical-vector-construction"></a>
</h3>
<p>If you are constructing a length 1 logical vector you may need to
explicitly use a <code>r_bool()</code> object in the initializer list
rather than <code>TRUE</code>, <code>FALSE</code> or
<code>NA_INTEGER</code>. This issue only occurs with the clang compiler,
not gcc. When constructing vectors with more than one element this is
not an issue</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">// bad</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>logicals<span class="op">({</span>FALSE<span class="op">});</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">// good</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>logicals<span class="op">({</span>r_bool<span class="op">(</span>FALSE<span class="op">)});</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">// good</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>logicals<span class="op">({</span>FALSE<span class="op">,</span> NA_LOGICAL<span class="op">});</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="http://jimhester.com" class="external-link">Jim Hester</a>, <a href="https://github.com/romainfrancois" class="external-link">Romain François</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
