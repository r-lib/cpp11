<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>FAQ • cpp11</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="FAQ">
<meta name="robots" content="noindex">
<script defer data-domain="cpp11.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cpp11</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.5.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/cpp11.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/motivations.html">Motivations</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/converting.html">Converting</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/FAQ.html">FAQ</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/internals.html">Internals</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><a class="dropdown-item" href="../news/index.html">Change log</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/cpp11/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>FAQ</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/cpp11/blob/main/vignettes/FAQ.Rmd" class="external-link"><code>vignettes/FAQ.Rmd</code></a></small>
      <div class="d-none name"><code>FAQ.Rmd</code></div>
    </div>

    
    
<p>Below are some Frequently Asked Questions about cpp11. If you have a
question that you think would fit well here please <a href="https://github.com/r-lib/cpp11/issues/new/choose" class="external-link">open an
issue</a>.</p>
<div class="section level4">
<h4 id="what-are-the-underlying-types-of-cpp11-objects">1. What are the underlying types of cpp11 objects?<a class="anchor" aria-label="anchor" href="#what-are-the-underlying-types-of-cpp11-objects"></a>
</h4>
<table class="table">
<thead><tr class="header">
<th>vector</th>
<th>element</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>cpp11::integers</td>
<td>int</td>
</tr>
<tr class="even">
<td>cpp11::doubles</td>
<td>double</td>
</tr>
<tr class="odd">
<td>cpp11::logicals</td>
<td>cpp11::r_bool</td>
</tr>
<tr class="even">
<td>cpp11::strings</td>
<td>cpp11::r_string</td>
</tr>
<tr class="odd">
<td>cpp11::raws</td>
<td>uint8_t</td>
</tr>
<tr class="even">
<td>cpp11::list</td>
<td>SEXP</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="how-do-i-add-elements-to-a-list">2. How do I add elements to a list?<a class="anchor" aria-label="anchor" href="#how-do-i-add-elements-to-a-list"></a>
</h4>
<p>Use the <code>push_back()</code> method. You will need to use
<code>cpp11::as_sexp()</code> if you want to convert arbitrary C++
objects to <code>SEXP</code> before inserting them into the list.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>list foo_push<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>list x<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="co">// An object that is already a `SEXP`</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>  x<span class="op">.</span>push_back<span class="op">(</span>R_NilValue<span class="op">);</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="co">// A single integer</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  x<span class="op">.</span>push_back<span class="op">(</span>cpp11<span class="op">::</span>as_sexp<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="co">// A C++ vector of ints</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> elt<span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  x<span class="op">.</span>push_back<span class="op">(</span>cpp11<span class="op">::</span>as_sexp<span class="op">(</span>elt<span class="op">));</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>To create named lists, use the <code>push_back()</code> method with
the named literal syntax. The named literal syntax is defined in the
<code>cpp11::literals</code> namespace. In this case, creating the named
literal automatically calls <code>as_sexp()</code> for you.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>list foo_push_named<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="kw">using</span> <span class="kw">namespace</span> cpp11<span class="op">::</span>literals<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>list x<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  x<span class="op">.</span>push_back<span class="op">({</span><span class="st">"foo"</span><span class="op">_nm</span> <span class="op">=</span> <span class="dv">1</span><span class="op">});</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that if you know the size of the list ahead of time (which you
often do!), then it is more efficient to state that up front.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>list foo_push_sized<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> elt<span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  <span class="dt">R_xlen_t</span> size <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>list x<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  x<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> R_NilValue<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  x<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> cpp11<span class="op">::</span>as_sexp<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  x<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> cpp11<span class="op">::</span>as_sexp<span class="op">(</span>elt<span class="op">);</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="does-cpp11-support-default-arguments">3. Does cpp11 support default arguments?<a class="anchor" aria-label="anchor" href="#does-cpp11-support-default-arguments"></a>
</h4>
<p>cpp11 does not support default arguments, while convenient they would
require more complexity to support than is currently worthwhile. If you
need default argument support you can use a wrapper function around your
cpp11 registered function. A common convention is to name the internal
function with a trailing <code>_</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="dt">double</span> <span class="va">add_some_</span><span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> amount<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">+</span> amount<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_some</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">amount</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">add_some_</span><span class="op">(</span><span class="va">x</span>, <span class="va">amount</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">add_some</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu">add_some</span><span class="op">(</span><span class="fl">1</span>, amount <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-create-a-new-empty-list">4. How do I create a new empty list?<a class="anchor" aria-label="anchor" href="#how-do-i-create-a-new-empty-list"></a>
</h4>
<p>Define a new writable list object.</p>
<p><code>cpp11::writable::list x;</code></p>
</div>
<div class="section level4">
<h4 id="how-do-i-retrieve-named-elements-from-a-named-vectorlist">5. How do I retrieve (named) elements from a named vector/list?<a class="anchor" aria-label="anchor" href="#how-do-i-retrieve-named-elements-from-a-named-vectorlist"></a>
</h4>
<p>Use the <code>[]</code> accessor function.</p>
<p><code>x["foo"]</code></p>
</div>
<div class="section level4">
<h4 id="how-can-i-tell-whether-a-vector-is-named">6. How can I tell whether a vector is named?<a class="anchor" aria-label="anchor" href="#how-can-i-tell-whether-a-vector-is-named"></a>
</h4>
<p>Use the <code>named()</code> method for vector classes.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="dt">bool</span> is_named<span class="op">(</span>cpp11<span class="op">::</span>strings x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">.</span>named<span class="op">();</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">is_named</span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="fu">is_named</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"foo"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-return-a-cpp11writablelogicals-object-with-only-a-false-value">7. How do I return a <code>cpp11::writable::logicals</code> object
with only a <code>FALSE</code> value?<a class="anchor" aria-label="anchor" href="#how-do-i-return-a-cpp11writablelogicals-object-with-only-a-false-value"></a>
</h4>
<p>You need to use <a href="https://en.cppreference.com/w/cpp/language/list_initialization" class="external-link">list
initialization</a> with <code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{}</a></code> to create the object.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>logicals my_false<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">{</span>FALSE<span class="op">};</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>logicals my_true<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">{</span>TRUE<span class="op">};</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>cpp11<span class="op">::</span>writable<span class="op">::</span>logicals my_both<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">{</span>TRUE<span class="op">,</span> FALSE<span class="op">,</span> TRUE<span class="op">};</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">my_false</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="fu">my_true</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="fu">my_both</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE FALSE  TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-create-a-new-empty-environment">8. How do I create a new empty environment?<a class="anchor" aria-label="anchor" href="#how-do-i-create-a-new-empty-environment"></a>
</h4>
<p>To do this you need to call the <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">base::new.env()</a></code> function
from C++. This can be done by creating a <code>cpp11::function</code>
object and then calling it to generate the new environment.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>cpp11<span class="op">::</span>environment create_environment<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  cpp11<span class="op">::</span>function new_env<span class="op">(</span>cpp11<span class="op">::</span>package<span class="op">(</span><span class="st">"base"</span><span class="op">)[</span><span class="st">"new.env"</span><span class="op">]);</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="cf">return</span> new_env<span class="op">();</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-assign-and-retrieve-values-in-an-environment-what-happens-if-i-try-to-get-a-value-that-doesnt-exist">9. How do I assign and retrieve values in an environment? What
happens if I try to get a value that doesn’t exist?<a class="anchor" aria-label="anchor" href="#how-do-i-assign-and-retrieve-values-in-an-environment-what-happens-if-i-try-to-get-a-value-that-doesnt-exist"></a>
</h4>
<p>Use <code>[]</code> to retrieve or assign values from an environment
by name. If a value does not exist, it will error. To check for
existence ahead of time, use the <code><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists()</a></code> method.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="dt">bool</span> foo_exists<span class="op">(</span>cpp11<span class="op">::</span>environment x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">.</span>exists<span class="op">(</span><span class="st">"foo"</span><span class="op">);</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="dt">void</span> set_foo<span class="op">(</span>cpp11<span class="op">::</span>environment x<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  x<span class="op">[</span><span class="st">"foo"</span><span class="op">]</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">foo_exists</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="fu">set_foo</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">foo_exists</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-can-i-create-a-cpp11raws-from-a-stdstring">10. How can I create a <code>cpp11:raws</code> from a
<code>std::string</code>?<a class="anchor" aria-label="anchor" href="#how-can-i-create-a-cpp11raws-from-a-stdstring"></a>
</h4>
<p>There is no built in way to do this. One method would be to
<code>push_back()</code> each element of the string individually.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>cpp11<span class="op">::</span>raws push_raws<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="bu">std::</span>string x<span class="op">(</span><span class="st">"hi"</span><span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>raws out<span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> c <span class="op">:</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    out<span class="op">.</span>push_back<span class="op">(</span>c<span class="op">);</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">push_raws</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 68 69</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-can-i-create-a-stdstring-from-a-cpp11writablestring">11. How can I create a <code>std::string</code> from a
<code>cpp11::writable::string</code>?<a class="anchor" aria-label="anchor" href="#how-can-i-create-a-stdstring-from-a-cpp11writablestring"></a>
</h4>
<p>Because C++ does not allow for two implicit cast, explicitly cast to
<code>cpp11::r_string</code> first.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="bu">std::</span>string my_string<span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>strings x<span class="op">({</span><span class="st">"foo"</span><span class="op">,</span> <span class="st">"bar"</span><span class="op">});</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  <span class="bu">std::</span>string elt <span class="op">=</span> cpp11<span class="op">::</span>r_string<span class="op">(</span>x<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="cf">return</span> elt<span class="op">;</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="what-are-the-types-for-c-iterators">12. What are the types for C++ iterators?<a class="anchor" aria-label="anchor" href="#what-are-the-types-for-c-iterators"></a>
</h4>
<p>The iterators are <code>::iterator</code> classes contained inside
the vector classes. For example the iterator for
<code>cpp11::doubles</code> would be
<code>cpp11::doubles::iterator</code> and the iterator for
<code>cpp11::writable::doubles</code> would be
<code>cpp11::writable::doubles::iterator</code>.</p>
</div>
<div class="section level4">
<h4 id="my-code-has-using-namespace-std-why-do-i-still-have-to-include-std-in-the-signatures-of-cpp11register-functions">13. My code has <code>using namespace std</code>, why do I still
have to include <code>std::</code> in the signatures of
<code>[[cpp11::register]]</code> functions?<a class="anchor" aria-label="anchor" href="#my-code-has-using-namespace-std-why-do-i-still-have-to-include-std-in-the-signatures-of-cpp11register-functions"></a>
</h4>
<p>The <code>using namespace std</code> directive will not be included
in the generated code of the function signatures, so they still need to
be fully qualified. However you will <em>not</em> need to qualify the
type names within those functions.</p>
<p>The following won’t compile</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>string foobar<span class="op">()</span> <span class="op">{</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>  <span class="cf">return</span> string<span class="op">(</span><span class="st">"foo"</span><span class="op">)</span> <span class="op">+</span> <span class="st">"-bar"</span><span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>But this will compile and work as intended</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="bu">std::</span>string foobar<span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>  <span class="cf">return</span> string<span class="op">(</span><span class="st">"foo"</span><span class="op">)</span> <span class="op">+</span> <span class="st">"-bar"</span><span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-modify-a-vector-in-place">14. How do I modify a vector in place?<a class="anchor" aria-label="anchor" href="#how-do-i-modify-a-vector-in-place"></a>
</h4>
<p>In place modification breaks the normal semantics of R code. In
general it should be avoided, which is why <code>cpp11::writable</code>
classes always copy their data when constructed.</p>
<p>However if you are <em>positive</em> in-place modification is
necessary for your use case you can use the move constructor to do
this.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="dt">void</span> add_one<span class="op">(</span>cpp11<span class="op">::</span>sexp x_sexp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>integers x<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>x_sexp<span class="op">.</span>data<span class="op">()));</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> value <span class="op">:</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>    <span class="op">++</span>value<span class="op">;</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">2L</span>, <span class="fl">3L</span>, <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Internal.html" class="external-link">.Internal</a></span><span class="op">(</span><span class="fu">inspect</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; @562fd48d0f38 13 INTSXP g0c2 [REF(2)] (len=4, tl=0) 1,2,3,4</span></span>
<span><span class="fu">add_one</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Internal.html" class="external-link">.Internal</a></span><span class="op">(</span><span class="fu">inspect</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; @562fd48d0f38 13 INTSXP g0c2 [REF(5)] (len=4, tl=0) 2,3,4,5</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 2 3 4 5</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="should-i-call-cpp11unwind_protect-manually">15. Should I call <code>cpp11::unwind_protect()</code>
manually?<a class="anchor" aria-label="anchor" href="#should-i-call-cpp11unwind_protect-manually"></a>
</h4>
<p><code>cpp11::unwind_protect()</code> is cpp11’s way of safely calling
R’s C API. In short, it allows you to run a function that might throw an
R error, catch the <code>longjmp()</code> of that error, promote it to
an exception that is thrown and caught by a try/catch that cpp11 sets up
for you at <code><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call()</a></code> time (which allows destructors to run),
and finally tells R to continue unwinding the stack now that the C++
objects have had a chance to destruct as needed.</p>
<p>Since <code>cpp11::unwind_protect()</code> takes an arbitrary
function, you may be wondering if you should use it for your own custom
needs. In general, we advise against this because this is an extremely
advanced feature that is prone to subtle and hard to debug issues.</p>
<div class="section level5">
<h5 id="destructors">Destructors<a class="anchor" aria-label="anchor" href="#destructors"></a>
</h5>
<p>The following setup for <code>test_destructor_ok()</code> with a
manual call to <code>unwind_protect()</code> would work:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>  <span class="op">~</span>A<span class="op">();</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>A<span class="op">::~</span>A<span class="op">()</span> <span class="op">{</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  Rprintf<span class="op">(</span><span class="st">"hi from the destructor!"</span><span class="op">);</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a><span class="dt">void</span> test_destructor_ok<span class="op">()</span> <span class="op">{</span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>  A a<span class="op">{};</span></span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>  cpp11<span class="op">::</span>unwind_protect<span class="op">([&amp;]</span> <span class="op">{</span></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>    Rf_error<span class="op">(</span><span class="st">"oh no!"</span><span class="op">);</span></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>  <span class="op">});</span></span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a><span class="dt">void</span> test_destructor_bad<span class="op">()</span> <span class="op">{</span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a>  cpp11<span class="op">::</span>unwind_protect<span class="op">([&amp;]</span> <span class="op">{</span></span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>    A a<span class="op">{};</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>    Rf_error<span class="op">(</span><span class="st">"oh no!"</span><span class="op">);</span></span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>  <span class="op">});</span></span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_destructor_ok</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: oh no!</span></span></code></pre></div>
<p>But if you happen to move <code>a</code> into the
<code>unwind_protect()</code>, then it won’t be destructed, and you’ll
end up with a memory leak at best, and a much more sinister issue if
your destructor is important:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_destructor_bad</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: oh no!</span></span></code></pre></div>
<p>In general, the only code that can be called within
<code>unwind_protect()</code> is “pure” C code or C++ code that only
uses POD (plain-old-data) types and no exceptions. If you mix complex
C++ objects with R’s C API within <code>unwind_protect()</code>, then
any R errors will result in a jump that prevents your destructors from
running.</p>
</div>
<div class="section level5">
<h5 id="nested-unwind_protect">Nested <code>unwind_protect()</code><a class="anchor" aria-label="anchor" href="#nested-unwind_protect"></a>
</h5>
<p>Another issue that can arise has to do with <em>nested</em> calls to
<code>unwind_protect()</code>. It is very hard (if not impossible) to
end up with invalidly nested <code>unwind_protect()</code> calls when
using the typical cpp11 API, but you can manually create a scenario like
the following:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="dt">void</span> test_nested<span class="op">()</span> <span class="op">{</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  cpp11<span class="op">::</span>unwind_protect<span class="op">([&amp;]</span> <span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>    cpp11<span class="op">::</span>unwind_protect<span class="op">([&amp;]</span> <span class="op">{</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>      Rf_error<span class="op">(</span><span class="st">"oh no!"</span><span class="op">);</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  <span class="op">});</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you were to run <code>test_nested()</code> from R, it would likely
crash or hang your R session due to the following chain of events:</p>
<ul>
<li>
<code>test_nested()</code> sets up a try/catch to catch unwind
exceptions</li>
<li>The outer <code>unwind_protect()</code> is called. It uses the C
function <code>R_UnwindProtect()</code> to call its lambda
function.</li>
<li>The inner <code>unwind_protect()</code> is called. It again uses
<code>R_UnwindProtect()</code>, this time to call
<code>Rf_error()</code>.</li>
<li>
<code>Rf_error()</code> performs a <code>longjmp()</code> which is
caught by the inner <code>unwind_protect()</code> and promoted to an
exception.</li>
<li>That exception is thrown, but because we are in the outer call to
<code>R_UnwindProtect()</code> (a C function), we end up throwing that
exception <em>across</em> C stack frames. This is <em>undefined
behavior</em>, which is known to have caused R to crash on certain
platforms.</li>
</ul>
<p>You might think that you’d never do this, but the same scenario can
also occur with a combination of 1 call to <code>unwind_protect()</code>
combined with usage of the cpp11 API:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="dt">void</span> test_hidden_nested<span class="op">()</span> <span class="op">{</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  cpp11<span class="op">::</span>unwind_protect<span class="op">([&amp;]</span> <span class="op">{</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>    cpp11<span class="op">::</span>stop<span class="op">(</span><span class="st">"oh no!"</span><span class="op">);</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  <span class="op">});</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Because <code><a href="https://rdrr.io/r/base/stop.html" class="external-link">cpp11::stop()</a></code> (and most of the cpp11 API) uses
<code>unwind_protect()</code> internally, we’ve indirectly ended up in a
nested <code>unwind_protect()</code> scenario again.</p>
<p>In general, if you must use <code>unwind_protect()</code> then you
must be very careful not to use any of the cpp11 API inside of the
<code>unwind_protect()</code> call.</p>
<p>It is worth pointing out that calling out to an R function from cpp11
which then calls back into cpp11 is still safe, i.e. if the registered
version of the imaginary <code>test_outer()</code> function below was
called from R, then that would work:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="dt">void</span> test_inner<span class="op">()</span> <span class="op">{</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  cpp11<span class="op">::</span>stop<span class="op">(</span><span class="st">"oh no!"</span><span class="op">)</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="dt">void</span> test_outer<span class="op">()</span> <span class="op">{</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>  <span class="kw">auto</span> fn <span class="op">=</span> cpp11<span class="op">::</span>package<span class="op">(</span><span class="st">"mypackage"</span><span class="op">)[</span><span class="st">"test_inner"</span><span class="op">]</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>  fn<span class="op">();</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This might seem unsafe because <code>cpp11::package()</code> uses
<code>unwind_protect()</code> to call the R function for
<code>test_inner()</code>, which then goes back into C++ to call
<code><a href="https://rdrr.io/r/base/stop.html" class="external-link">cpp11::stop()</a></code>, which itself uses
<code>unwind_protect()</code>, so it seems like we are in a nested
scenario, but this scenario does actually work. It makes more sense if
we analyze it one step at a time:</p>
<ul>
<li>Call the R function for <code>test_outer()</code>
</li>
<li>A try/catch is set up to catch unwind exceptions</li>
<li>The C++ function for <code>test_outer()</code> is called</li>
<li>
<code>cpp11::package()</code> uses <code>unwind_protect()</code> to
call the R function for <code>test_inner()</code>
</li>
<li>Call the R function for <code>test_inner()</code>
</li>
<li>A try/catch is set up to catch unwind exceptions (<em>this is the
key!</em>)</li>
<li>The C++ function for <code>test_inner()</code> is called</li>
<li>
<code>cpp11::stop("oh no!")</code> is called, which uses
<code>unwind_protect()</code> to call <code>Rf_error()</code>, causing a
<code>longjmp()</code>, which is caught by that
<code>unwind_protect()</code> and promoted to an exception.</li>
<li>That exception is thrown, but this time it is caught by the
try/catch set up by <code>test_inner()</code> as we entered it from the
R side. This prevents that exception from crossing the C++ -&gt; C
boundary.</li>
<li>The try/catch calls <code>R_ContinueUnwind()</code>, which
<code>longjmp()</code>s again, and now the <code>unwind_protect()</code>
set up by <code>cpp11::package()</code> catches that, and promotes it to
an exception.</li>
<li>That exception is thrown and caught by the try/catch set up by
<code>test_outer()</code>.</li>
<li>The try/catch calls <code>R_ContinueUnwind()</code>, which
<code>longjmp()</code>s again, and at this point we can safely let the
<code>longjmp()</code> proceed to force an R error.</li>
</ul>
</div>
</div>
<div class="section level4">
<h4 id="ok-but-i-really-want-to-call-cpp11unwind_protect-manually">16. Ok but I really want to call
<code>cpp11::unwind_protect()</code> manually<a class="anchor" aria-label="anchor" href="#ok-but-i-really-want-to-call-cpp11unwind_protect-manually"></a>
</h4>
<p>If you’ve read the above bullet and still feel like you need to call
<code>unwind_protect()</code>, then you should keep in mind the
following when writing the function to unwind-protect:</p>
<ul>
<li>You shouldn’t create any C++ objects that have destructors.</li>
<li>You shouldn’t use any parts of the cpp11 API that may call
<code>unwind_protect()</code>.</li>
<li>You must be very careful not to call <code>unwind_protect()</code>
in a nested manner.</li>
</ul>
<p>In other words, if you only use plain-old-data types, are careful to
never throw exceptions, and only use R’s C API, then you can use
<code>unwind_protect()</code>.</p>
<p>One place you may want to do this is when working with long character
vectors. Unfortunately, due to the way cpp11 must protect the individual
CHARSXP objects that make up a character vector, it can currently be
quite slow to use the cpp11 API for this. Consider this example of
extracting out individual elements with <code>x[i]</code> vs using the
native R API:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>cpp11<span class="op">::</span>sexp test_extract_cpp11<span class="op">(</span>cpp11<span class="op">::</span>strings x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">R_xlen_t</span> size <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">R_xlen_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>    <span class="op">(</span><span class="dt">void</span><span class="op">)</span> x<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>  <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>cpp11<span class="op">::</span>sexp test_extract_r_api<span class="op">(</span>cpp11<span class="op">::</span>strings x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">R_xlen_t</span> size <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>  <span class="at">const</span> SEXP data<span class="op">{</span>x<span class="op">};</span></span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>  cpp11<span class="op">::</span>unwind_protect<span class="op">([&amp;]</span> <span class="op">{</span></span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">R_xlen_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>      <span class="op">(</span><span class="dt">void</span><span class="op">)</span> STRING_ELT<span class="op">(</span>data<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>  <span class="op">});</span></span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a>  <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">letters</span>, <span class="fl">1e6</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="fu">test_extract_cpp11</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>  <span class="fu">test_extract_r_api</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is</span></span>
<span><span class="co">#&gt; disabled.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   expression                 min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;bch:tm&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:tm&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> test_extract_cpp11(x)   38.8ms  40.64ms      23.4        0B     42.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> test_extract_r_api(x)   1.85ms   1.86ms     536.         0B      0</span></span></code></pre></div>
<p>We plan to improve on this in the future, but for now this is one of
the only places where we feel it is reasonable to call
<code>unwind_protect()</code> manually.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="http://jimhester.com" class="external-link">Jim Hester</a>, <a href="https://github.com/romainfrancois" class="external-link">Romain François</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
