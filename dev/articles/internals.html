<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>cpp11 internals • cpp11</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="cpp11 internals">
<meta name="robots" content="noindex">
<script defer data-domain="cpp11.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cpp11</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.5.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/cpp11.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/motivations.html">Motivations</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/converting.html">Converting</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/FAQ.html">FAQ</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/internals.html">Internals</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><a class="dropdown-item" href="../news/index.html">Change log</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/cpp11/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>cpp11 internals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/cpp11/blob/main/vignettes/internals.Rmd" class="external-link"><code>vignettes/internals.Rmd</code></a></small>
      <div class="d-none name"><code>internals.Rmd</code></div>
    </div>

    
    
<p>The development repository for cpp11 is <a href="https://github.com/r-lib/cpp11" class="external-link uri">https://github.com/r-lib/cpp11</a>.</p>
<div class="section level2">
<h2 id="initial-setup-and-dev-workflow">Initial setup and dev workflow<a class="anchor" aria-label="anchor" href="#initial-setup-and-dev-workflow"></a>
</h2>
<p>First install any dependencies needed for development.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_deps</span><span class="op">(</span>dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>You can load the package in an interactive R session</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Or run the cpp11 tests with</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>There are more extensive tests in the <code>cpp11test</code>
directory. Generally when developing the C++ headers I run R with its
working directory in the <code>cpp11test</code> directory and use
<code>devtools::test()</code> to run the cpp11tests.</p>
<p>If you change the cpp11 headers you will need to install the new
version of cpp11 and then clean and recompile the cpp11test package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assuming your working directory is `cpp11test/`</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">clean_dll</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>To calculate code coverage of the cpp11 package run the following
from the <code>cpp11</code> root directory.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">covr</span><span class="fu">::</span><span class="fu"><a href="http://covr.r-lib.org/reference/report.html" class="external-link">report</a></span><span class="op">(</span><span class="fu">cpp11_coverage</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="code-formatting">Code formatting<a class="anchor" aria-label="anchor" href="#code-formatting"></a>
</h2>
<p>This project uses <a href="https://clang.llvm.org/docs/ClangFormat.html" class="external-link">clang-format</a>
(version 10) to automatically format the c++ code.</p>
<p>You can run <code>make format</code> to re-format all code in the
project. If your system does not have <code>clang-format</code> version
10, this can be installed using a <a href="https://github.com/r-lib/homebrew-taps" class="external-link">homebrew tap</a> at the
command line with
<code>brew install r-lib/taps/clang-format@10</code>.</p>
<p>You may need to link the newly installed version 10. To do so, run
<code>brew unlink clang-format</code> followed by
<code>brew link clang-format@10</code>.</p>
<p>Alternatively many IDEs support automatically running
<code>clang-format</code> every time files are written.</p>
</div>
<div class="section level2">
<h2 id="code-organization">Code organization<a class="anchor" aria-label="anchor" href="#code-organization"></a>
</h2>
<p>cpp11 is a header only library, so all source code exposed to users
lives in <a href="https://github.com/r-lib/cpp11/tree/main/inst/include" class="external-link">inst/include</a>.
R code used to register functions and for
<code><a href="../reference/cpp_source.html">cpp11::cpp_source()</a></code> is in <a href="https://github.com/r-lib/cpp11/tree/main/R" class="external-link">R/</a>. Tests for
<em>only</em> the code in <code>R/</code> is in <a href="https://github.com/r-lib/cpp11/tree/main/tests/testthat" class="external-link">tests/testthat/</a>.
The rest of the code is in a separate <a href="https://github.com/r-lib/cpp11/tree/main/cpp11test" class="external-link">cpp11test/</a>
package included in the source tree. Inside <a href="https://github.com/r-lib/cpp11/tree/main/cpp11test/src" class="external-link">cpp11test/src</a>
the files that start with <code>test-</code> are C++ tests using the <a href="https://testthat.r-lib.org/reference/use_catch.html" class="external-link">Catch</a>
support in testthat. In addition there are some regular R tests in <a href="https://github.com/r-lib/cpp11/tree/main/cpp11test/tests/testthat" class="external-link">cpp11test/tests/testthat/</a>.</p>
</div>
<div class="section level2">
<h2 id="naming-conventions">Naming conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a>
</h2>
<ul>
<li>All header files are named with a <code>.hpp</code> extension.</li>
<li>All source files are named with a <code>.cpp</code> extension.</li>
<li>Public header files should be put in
<code>inst/include/cpp11</code>
</li>
<li>Read only r_vector classes and free functions should be put in the
<code>cpp11</code> namespace.</li>
<li>Writable r_vector class should be put in the
<code>cpp11::writable</code> namespace.</li>
<li>Private classes and functions should be put in the
<code>cpp11::internal</code> namespace.</li>
</ul>
</div>
<div class="section level2">
<h2 id="vector-classes">Vector classes<a class="anchor" aria-label="anchor" href="#vector-classes"></a>
</h2>
<p>All of the basic r_vector classes are class templates, the base
template is defined in <a href="https://github.com/r-lib/cpp11/blob/main/inst/include/cpp11/r_vector.hpp" class="external-link">cpp11/r_vector.hpp</a>.
The template parameter is the type of <strong>value</strong> the
particular R vector stores, e.g. <code>double</code> for
<code>cpp11::doubles</code>. This differs from Rcpp, whose first
template parameter is the R vector type, e.g. <code>REALSXP</code>.</p>
<p>The file first has the class declarations, then function definitions
further down in the file. Specializations for the various types are in
separate files, e.g. <a href="https://github.com/r-lib/cpp11/blob/main/inst/include/cpp11/doubles.hpp" class="external-link">cpp11/doubles.hpp</a>,
<a href="https://github.com/r-lib/cpp11/blob/main/inst/include/cpp11/integers.hpp" class="external-link">cpp11/integers.hpp</a></p>
</div>
<div class="section level2">
<h2 id="coercion-functions">Coercion functions<a class="anchor" aria-label="anchor" href="#coercion-functions"></a>
</h2>
<p>There are two different coercion functions</p>
<p><code>as_sexp()</code> takes a C++ object and coerces it to a SEXP
object, so it can be used in R. <code>as_cpp&lt;&gt;()</code> is a
template function that takes a SEXP and creates a C++ object from it</p>
<p>The various methods for both functions are defined in <a href="https://github.com/r-lib/cpp11/blob/main/inst/include/cpp11/as.hpp" class="external-link">cpp11/as.hpp</a></p>
<p>This is definitely the most complex part of the cpp11 code, with
extensive use of <a href="https://en.wikipedia.org/wiki/Template_metaprogramming" class="external-link">template
metaprogramming</a>. In particular the <a href="https://en.wikipedia.org/wiki/Substitution_failure_is_not_an_error" class="external-link">substitution
failure is not an error (SFINAE)</a> technique is used to control
overloading of the functions. If we could use C++20 a lot of this code
would be made simpler with <a href="https://en.cppreference.com/w/cpp/language/constraints" class="external-link">Concepts</a>,
but alas.</p>
<p>The most common C++ types are included in the test suite and should
work without issues, as more exotic types are used in real projects
additional issues may arise.</p>
<p>Some useful links on SFINAE</p>
<ul>
<li>
<a href="https://www.fluentcpp.com/2018/05/15/make-sfinae-pretty-1-what-value-sfinae-brings-to-code/" class="external-link uri">https://www.fluentcpp.com/2018/05/15/make-sfinae-pretty-1-what-value-sfinae-brings-to-code/</a>,
<a href="https://www.fluentcpp.com/2018/05/18/make-sfinae-pretty-2-hidden-beauty-sfinae/" class="external-link uri">https://www.fluentcpp.com/2018/05/18/make-sfinae-pretty-2-hidden-beauty-sfinae/</a>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="protection">Protection<a class="anchor" aria-label="anchor" href="#protection"></a>
</h2>
<div class="section level3">
<h3 id="protect-list">Protect list<a class="anchor" aria-label="anchor" href="#protect-list"></a>
</h3>
<p>cpp11 uses an idea proposed by <a href="https://github.com/RcppCore/Rcpp/issues/1081#issuecomment-630330838" class="external-link">Luke
Tierney</a> to use a double linked list with the head preserved to
protect objects cpp11 is protecting.</p>
<p>Each node in the list uses the head (<code>CAR</code>) part to point
to the previous node, and the <code>CDR</code> part to point to the next
node. The <code>TAG</code> is used to point to the object being
protected. The head and tail of the list have <code>R_NilValue</code> as
their <code>CAR</code> and <code>CDR</code> pointers respectively.</p>
<p>Calling <code>cpp11::detail::store::insert()</code> with a regular R
object will add a new node to the list and return a protect token
corresponding to the node added. Calling
<code>cpp11::detail::store::release()</code> on this returned token will
release the protection by unlinking the node from the linked list. These
two functions are considered internal to cpp11, so do not use them in
your packages.</p>
<p>This scheme scales in O(1) time to release or insert an object vs
O(N) or worse time with <code>R_PreserveObject()</code> /
<code>R_ReleaseObject()</code>.</p>
<p>Each package has its own unique protection list, which avoids the
need to manage a “global” protection list shared across packages. A
previous version of cpp11 used a global protection list stored in an R
global option, but this caused <a href="https://github.com/r-lib/cpp11/issues/330" class="external-link">multiple
issues</a>.</p>
<p>These functions are defined in <a href="https://github.com/r-lib/cpp11/blob/main/inst/include/cpp11/protect.hpp" class="external-link">protect.hpp</a>.</p>
</div>
<div class="section level3">
<h3 id="unwind-protect">Unwind Protect<a class="anchor" aria-label="anchor" href="#unwind-protect"></a>
</h3>
<p>cpp11 uses <code>R_UnwindProtect()</code> to protect (most) calls to
the R API that could fail. These are usually those that allocate memory,
though in truth most R API functions could error along some paths. If an
error happens under <code>R_UnwindProtect()</code>, cpp11 will throw a
C++ exception. This exception is caught by the try/catch block defined
in the <code>BEGIN_CPP11</code> macro in <a href="https://github.com/r-lib/cpp11/blob/main/inst/include/cpp11/declarations.hpp" class="external-link">cpp11/declarations.hpp</a>.
The exception will cause any C++ destructors to run, freeing any
resources held by C++ objects. After the try/catch block exits, the R
error unwinding is then continued by <code>R_ContinueUnwind()</code> and
a normal R error results.</p>
<p>We require R &gt;=3.5 to use cpp11, but when it was created we wanted
to support back to R 3.3, but <code>R_ContinueUnwind()</code> wasn’t
available until R 3.5. Below are a few other options we considered to
support older R versions:</p>
<ol style="list-style-type: decimal">
<li>Using <code>R_TopLevelExec()</code> works to avoid the C long jump,
but because the code is always run in a top level context any errors or
messages thrown cannot be caught by <code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch()</a></code> or similar
techniques.</li>
<li>Using <code>R_TryCatch()</code> is not available prior to R 3.4, and
also has a serious bug in R 3.4 (fixed in R 3.5).</li>
<li>Calling the R level <code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch()</a></code> function which contains
an expression that runs a C function which then runs the C++ code would
be an option, but implementing this is convoluted and it would impact
performance, perhaps severely.</li>
<li>Have <code>cpp11::unwind_protect()</code> be a no-op for these
versions. This means any resources held by C++ objects would leak,
including <code>cpp11::r_vector</code> / <code>cpp11::sexp</code>
objects.</li>
</ol>
<p>None of these options were perfect, here are some pros and cons for
each.</p>
<ol style="list-style-type: decimal">
<li>Causes behavior changes and test failures, so it was ruled out.</li>
<li>Was also ruled out since we wanted to support back to R 3.3.</li>
<li>Was ruled out partially because the implementation would be somewhat
tricky and more because performance would suffer greatly.</li>
<li>Is what we ended up doing before requiring R 3.5. It leaked
protected objects when there were R API errors.</li>
</ol>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="http://jimhester.com" class="external-link">Jim Hester</a>, <a href="https://github.com/romainfrancois" class="external-link">Romain François</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
